import datetime as dt
import json
from typing import Any, Set, Dict

class PersonOOP1:
    def __init__(self, name: str, born_in: dt.datetime) -> None:
        self._name = name
        self._friends: list['PersonOOP1'] = []
        self._born_in = born_in
    
    def add_friend(self, friend: 'PersonOOP1') -> None:
        self._friends.append(friend)
        friend._friends.append(self)


def encode_oop1(person: PersonOOP1) -> bytes:
    visited: Set[int] = set()
    def person_to_dict(p: PersonOOP1) -> Dict[str, Any]:
        person_id = id(p)
        
        if person_id in visited:
            return {"_ref": person_id}
        visited.add(person_id)
        return {
            "id": person_id,
            "name": p._name,  # НАРУШЕНИЕ: прямой доступ к приватному атрибуту
            "born_in": p._born_in.isoformat(),
            "friends": [person_to_dict(f) for f in p._friends]
        }
    data = person_to_dict(person)
    return json.dumps(data).encode('utf-8')


def decode_oop1(data: bytes) -> PersonOOP1:
    obj_map: Dict[int, PersonOOP1] = {}
    def dict_to_person(d: Dict[str, Any]) -> PersonOOP1:
        if "_ref" in d:
            return obj_map[d["_ref"]]
        person_id = d["id"]
        if person_id in obj_map:
            return obj_map[person_id]
        person = PersonOOP1(d["name"], dt.datetime.fromisoformat(d["born_in"]))
        obj_map[person_id] = person
        person._friends = [dict_to_person(f) for f in d["friends"]]
        return person
    parsed = json.loads(data.decode('utf-8'))
    return dict_to_person(parsed)