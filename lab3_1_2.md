class PersonOOP2:
    def __init__(self, name: str, born_in: dt.datetime) -> None:
        self._name = name
        self._friends: list['PersonOOP2'] = []
        self._born_in = born_in
    
    def add_friend(self, friend: 'PersonOOP2') -> None:
        self._friends.append(friend)
        friend._friends.append(self)
    
    def to_dict(self, visited: Set[int] = None) -> Dict[str, Any]:
        """Метод для преобразования в словарь с обработкой циклических ссылок."""
        if visited is None:
            visited = set()
        person_id = id(self)
        if person_id in visited:
            return {"_ref": person_id}
        visited.add(person_id)
        return {
            "id": person_id,
            "name": self._name,
            "born_in": self._born_in.isoformat(),
            "friends": [f.to_dict(visited) for f in self._friends]
        }
    @staticmethod
    def from_dict(data: Dict[str, Any], obj_map: Dict[int, 'PersonOOP2'] = None) -> 'PersonOOP2':
        if obj_map is None:
            obj_map = {}
        if "_ref" in data:
            return obj_map[data["_ref"]]
        person_id = data["id"]
        if person_id in obj_map:
            return obj_map[person_id]
        person = PersonOOP2(data["name"], dt.datetime.fromisoformat(data["born_in"]))
        obj_map[person_id] = person
        person._friends = [PersonOOP2.from_dict(f, obj_map) for f in data["friends"]]
        return person


def encode_oop2(person: PersonOOP2) -> bytes:
    data = person.to_dict()
    return json.dumps(data).encode('utf-8')

def decode_oop2(data: bytes) -> PersonOOP2:
    """Декодирование PersonOOP2."""
    parsed = json.loads(data.decode('utf-8'))
    return PersonOOP2.from_dict(parsed)