class PersonOOP3:
    def __init__(self, name: str, born_in: dt.datetime) -> None:
        self._name = name
        self._friends: list['PersonOOP3'] = []
        self._born_in = born_in
    
    def add_friend(self, friend: 'PersonOOP3') -> None:
        self._friends.append(friend)
        friend._friends.append(self)
    
    def __getstate__(self) -> Dict[str, Any]:
        return {
            "name": self._name,
            "born_in": self._born_in.isoformat(),
            "friends_ids": [id(f) for f in self._friends]
        }
    
    def __setstate__(self, state: Dict[str, Any]) -> None:
        self._name = state["name"]
        self._born_in = dt.datetime.fromisoformat(state["born_in"])
        self._friends = []

def encode_oop3(person: PersonOOP3) -> bytes:
    visited: Set[int] = set()
    person_map: Dict[int, PersonOOP3] = {}
    
    def collect_persons(p: PersonOOP3) -> None:
        person_id = id(p)
        if person_id in visited:
            return
        visited.add(person_id)
        person_map[person_id] = p
        for friend in p._friends:
            collect_persons(friend)
    collect_persons(person)
    encoded_people: Dict[str, Dict[str, Any]] = {}
    for person_id, p in person_map.items():
        state = p.__getstate__()
        encoded_people[str(person_id)] = state
    data = {
        "root_id": id(person),
        "people": encoded_people
    }
    return json.dumps(data).encode('utf-8')

def decode_oop3(data: bytes) -> PersonOOP3:
    parsed = json.loads(data.decode('utf-8'))
    root_id = int(parsed["root_id"])
    people_data = parsed["people"]
    person_map: Dict[int, PersonOOP3] = {}
    for person_id_str, state in people_data.items():
        person_id = int(person_id_str)
        person = PersonOOP3.__new__(PersonOOP3)  # Создаём без конструктора!
        person.__setstate__(state)
        person_map[person_id] = person

    for person_id_str, state in people_data.items():
        person_id = int(person_id_str)
        person = person_map[person_id]
        for friend_id in state.get("friends_ids", []):
            if friend_id in person_map:
                person._friends.append(person_map[friend_id])
    
    return person_map[root_id]
